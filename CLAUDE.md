# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is an Elixir/Phoenix umbrella monorepo with a React + GraphQL frontend. The umbrella root is at `/`, with apps in `apps/`. The primary app is `apps/client`.

## Development Setup

```bash
bin/setup           # Initial setup (requires mise and op CLI)
iex -S mix phx.server  # Start the server (localhost:4000)
```

## Common Commands

### Elixir / Backend

```bash
mix test                                    # Run all tests
mix test apps/client/test/path/to_test.exs  # Run a single test file
mix test apps/client/test/path/to_test.exs:42  # Run a single test
mix ecto.migrate                            # Run migrations
mix phx.routes                              # List routes (aliased to ClientWeb.Router)
mix dialyzer                                # Run dialyzer type analysis
```

### Frontend (run from `apps/client/assets/`)

```bash
yarn lint --check # Check formatting with prettier
yarn lint --write # Fix any prettier formatting errors
yarn typecheck    # TypeScript type checking
yarn codegen      # Regenerate GraphQL types (requires server running on :4000)
```

### Running Playwright Tests

Start the test server first, then run Playwright:

```bash
# Terminal 1: start test server
MIX_ENV=test mix phx.server

# Terminal 2: run tests
cd apps/client/assets
npx playwright test                         # Run all tests
npx playwright test tests/auth.spec.ts      # Run a single test file
npx playwright test --grep "test name"      # Run tests matching a pattern
```

## Architecture

### Umbrella Structure

- **`apps/client`** — Main Phoenix app. Contains the web layer, business logic, Ecto repos, GraphQL schema, and LiveView pages.
- **`apps/events`** — Event handling/broadcasting logic.
- **`apps/redis`** — Redis connection wrapper.
- **`apps/twitch`** — Twitch integration (API + webhooks). Has its own Ecto repo (`Twitch.Repo`).

### Backend (Phoenix/Elixir)

The `apps/client` app has two primary namespaces:

- **`Client`** — Business logic contexts (e.g., `Client.FoodLogs`, `Client.IjustContext`, `Client.Soap`).
- **`ClientWeb`** — Web layer with controllers, LiveViews, and the GraphQL resolvers.

**Authentication:** Guardian-based JWT for the GraphQL/React side. Phoenix sessions for the LiveView/server-rendered side. In test env, the `TestAuthHelper` plug allows bypassing auth via `?as=<user_id>` query param.

**GraphQL:** Absinthe serves the schema at `/graphql`. Schema types are defined in `apps/client/lib/client_web/schema.ex` and resolvers are in `apps/client/lib/client_web/resolvers/`.

**Dual frontend approach:** Some features use traditional Phoenix controllers + LiveView (food logs, water logs, soap, storage, repeatable lists, train logs). Others use the React SPA via the GraphQL API (teams, ijust, settings, twitch). The SPA is mounted in the root layout and uses hash-based routing (`#/route`).

### Frontend (React/TypeScript)

Located in `apps/client/assets/`:

- **`js/index.jsx`** — Entry point. Sets up urql GraphQL client with auth exchange, MUI theme, notistack.
- **`js/components/App.jsx`** — React Router setup (HashRouter). Routes map to `js/routes/`.
- **`js/gql/`** — Auto-generated GraphQL types (via `yarn codegen`). Do not edit manually.
- **`js/utils/`** — Auth exchange, cache exchange, theme.

The frontend uses urql for GraphQL with typed operations generated by graphql-codegen.

### Testing

**Elixir tests** use ExUnit. Feature/browser tests use Wallaby (headless Chrome). The `FeatureCase` module sets up Wallaby sessions. Factories use ExMachina via `Client.Factory`.

**Playwright tests** (`apps/client/assets/tests/`) test the React SPA. The `helpers.ts` provides:
- `insert(factory, attrs)` — calls a test-only `/factory/:factory` endpoint to create DB records
- `initSession(page, opts)` — creates a user and logs them in via the `?as=<user_id>` mechanism

Both test setups rely on the same `?as=<user_id>` bypass (only active in `MIX_ENV=test`) to avoid UI-based login flows in tests.

### Secret Management

Production secrets are in `secrets.txt.encrypted`. Decrypt with `./bin/decrypt_secrets.sh` (requires `key.txt` from 1Password "Homepage" vault). Re-encrypt with `./bin/encrypt_secrets.sh`.
